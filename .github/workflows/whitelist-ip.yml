name: Whitelist My IP in AWS Security Group

on:
  workflow_dispatch:  # allows manual trigger

jobs:
  whitelist:
    runs-on: ubuntu-latest

    env:
      SG_ID: sg-0e5b0fef93890d82a   # üîí your Security Group ID
      PORT: 27017                   # üîí the port you want to open (e.g., MongoDB)
      REGION: ap-south-1            # üîí your AWS region

    steps:
      - name: Get public IP
        id: ip
        run: |
          IP=$(curl -s https://checkip.amazonaws.com)
          echo "Public IP: $IP"
          echo "IP=$IP" >> $GITHUB_ENV

      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region $REGION

      - name: Remove old IPs (optional cleanup)
        run: |
          echo "Removing old IPs from SG $SG_ID for port $PORT..."
          OLD_IPS=$(aws ec2 describe-security-groups \
            --group-ids $SG_ID \
            --query "SecurityGroups[0].IpPermissions[?FromPort==\`${PORT}\`].IpRanges[].CidrIp" \
            --output text)
          for CIDR in $OLD_IPS; do
            echo "Revoking old rule: $CIDR"
            aws ec2 revoke-security-group-ingress \
              --group-id $SG_ID \
              --protocol tcp \
              --port $PORT \
              --cidr "$CIDR" || true
          done

      - name: Whitelist new IP
        run: |
          echo "Adding new IP: $IP/32 to SG $SG_ID for port $PORT"
          aws ec2 authorize-security-group-ingress \
            --group-id $SG_ID \
            --protocol tcp \
            --port $PORT \
            --cidr "$IP/32" \
            || echo "‚ö†Ô∏è IP may already exist or rule already added."
