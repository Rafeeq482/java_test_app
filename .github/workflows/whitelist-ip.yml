name: Whitelist IP in AWS Security Group

on:
  workflow_dispatch:
    inputs:
      ip:
        description: "Enter the IP address to whitelist (e.g. 123.45.67.89)"
        required: true

jobs:
  whitelist:
    runs-on: ubuntu-latest

    env:
      SG_ID: sg-092573a767146312c   # your Security Group ID
      PORT: 27017                   # the port you want to open (e.g., MongoDB)
      REGION: ap-south-1            # your AWS region

    steps:
      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region $REGION

      - name: Whitelist provided IP
        run: |
          IP=${{ github.event.inputs.ip }}
          echo "Whitelisting IP: $IP on port $PORT in SG $SG_ID..."
          aws ec2 authorize-security-group-ingress \
            --group-id $SG_ID \
            --protocol tcp \
            --port $PORT \
            --cidr "$IP/32" \
            || echo "⚠️ IP may already exist or rule already added."
